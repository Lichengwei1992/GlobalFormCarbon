library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2000_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),
ylim = c(-1, 1),
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1，
##########################################
## 0. 加载所需包
##########################################
library(readxl)
library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2000_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),
ylim = c(-1, 1),
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1，
##########################################
## 0. 加载所需包
##########################################
library(readxl)
library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2000_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),      # 或 x_range
ylim = c(-1, 1),        # 或 y_range
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1,
family = "Arial",       # 设置字体
cex.lab = 1.6,          # 坐标轴标题字体大小
cex.main = 1.6,         # 图标题字体大小
cex.axis = 1.3          # 坐标轴刻度字体大小
)
## 配置颜色渐变：从白到深蓝
my_cols <- colorRampPalette(
c("white", "#C8E4F9", "#83C7F3", "#379EE0", "#0059B3")
)(50)
## 填充核密度颜色
image(kd2, col = my_cols, add = TRUE)
## 等高线
contour(kd2,
nlevels    = 10,
drawlabels = FALSE,
lwd        = 1,
col        = "#333333",
add        = TRUE)
## 虚线辅助
abline(h = 0, v = 0, lty = 3, col = "gray40")
## --- E. envfit 分析 & 绘制 ---
ef <- envfit(nmds_result ~ ., data = vars_scaled, perm = 999)
cat("\nEnvfit results for group:", group_label, "\n")
print(ef)
## 使用 label.arg 传递 pos & offset，避免不是图形参数的警告
plot(ef,
p.max      = 0.05,          # 只画显著向量
col        = "black",       # 箭头颜色
lwd        = 1.5,           # 箭头线宽
cex        = 1.4,          # 字体大小
arrow.mul  = 1.1,           # 箭头缩放倍数
label.arg  = list(pos = 4,  # 文本相对位置(4=右侧)
offset = 0.4), # 文本与箭头间距
add        = TRUE)
}
##########################################
## 3. 循环对每个组别绘制
##########################################
for(g in unique_clusters) {
group_data <- subset(mydata, CLUSTER_ID == g)
plot_NMDS_kde_envfit(group_data, group_label = g)
}
##########################################
## 0. 加载所需包
##########################################
library(readxl)
library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2000_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),      # 或 x_range
ylim = c(-1, 1.2),        # 或 y_range
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1,
family = "Arial",       # 设置字体
cex.lab = 1.6,          # 坐标轴标题字体大小
cex.main = 1.6,         # 图标题字体大小
cex.axis = 1.3          # 坐标轴刻度字体大小
)
## 配置颜色渐变：从白到深蓝
my_cols <- colorRampPalette(
c("white", "#C8E4F9", "#83C7F3", "#379EE0", "#0059B3")
)(50)
## 填充核密度颜色
image(kd2, col = my_cols, add = TRUE)
## 等高线
contour(kd2,
nlevels    = 10,
drawlabels = FALSE,
lwd        = 1,
col        = "#333333",
add        = TRUE)
## 虚线辅助
abline(h = 0, v = 0, lty = 3, col = "gray40")
## --- E. envfit 分析 & 绘制 ---
ef <- envfit(nmds_result ~ ., data = vars_scaled, perm = 999)
cat("\nEnvfit results for group:", group_label, "\n")
print(ef)
## 使用 label.arg 传递 pos & offset，避免不是图形参数的警告
plot(ef,
p.max      = 0.05,          # 只画显著向量
col        = "black",       # 箭头颜色
lwd        = 1.5,           # 箭头线宽
cex        = 1.3,          # 字体大小
arrow.mul  = 1.1,           # 箭头缩放倍数
label.arg  = list(pos = 4,  # 文本相对位置(4=右侧)
offset = 0.4), # 文本与箭头间距
add        = TRUE)
}
##########################################
## 3. 循环对每个组别绘制
##########################################
for(g in unique_clusters) {
group_data <- subset(mydata, CLUSTER_ID == g)
plot_NMDS_kde_envfit(group_data, group_label = g)
}
##########################################
## 0. 加载所需包
##########################################
library(readxl)
library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2000_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),      # 或 x_range
ylim = c(-1.2, 1),        # 或 y_range
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1,
family = "Arial",       # 设置字体
cex.lab = 1.6,          # 坐标轴标题字体大小
cex.main = 1.6,         # 图标题字体大小
cex.axis = 1.3          # 坐标轴刻度字体大小
)
## 配置颜色渐变：从白到深蓝
my_cols <- colorRampPalette(
c("white", "#C8E4F9", "#83C7F3", "#379EE0", "#0059B3")
)(50)
## 填充核密度颜色
image(kd2, col = my_cols, add = TRUE)
## 等高线
contour(kd2,
nlevels    = 10,
drawlabels = FALSE,
lwd        = 1,
col        = "#333333",
add        = TRUE)
## 虚线辅助
abline(h = 0, v = 0, lty = 3, col = "gray40")
## --- E. envfit 分析 & 绘制 ---
ef <- envfit(nmds_result ~ ., data = vars_scaled, perm = 999)
cat("\nEnvfit results for group:", group_label, "\n")
print(ef)
## 使用 label.arg 传递 pos & offset，避免不是图形参数的警告
plot(ef,
p.max      = 0.05,          # 只画显著向量
col        = "black",       # 箭头颜色
lwd        = 1.5,           # 箭头线宽
cex        = 1.3,          # 字体大小
arrow.mul  = 1.1,           # 箭头缩放倍数
label.arg  = list(pos = 4,  # 文本相对位置(4=右侧)
offset = 0.4), # 文本与箭头间距
add        = TRUE)
}
##########################################
## 3. 循环对每个组别绘制
##########################################
for(g in unique_clusters) {
group_data <- subset(mydata, CLUSTER_ID == g)
plot_NMDS_kde_envfit(group_data, group_label = g)
}
##########################################
## 0. 加载所需包
##########################################
library(readxl)
library(vegan)
library(MASS)  # kde2d() 用于核密度估计
windowsFonts(Arial = windowsFont("Arial"))
##########################################
## 1. 导入数据
##########################################
data_raw <- read_excel("C:/Users/cl7613/Desktop/New folder (3)/2020_NEW.xlsx")
# 目标列：包含分组列CLUSTER_ID + 需要做NMDS的指标列
cols_needed <- c(
"CLUSTER_ID",
"urbanArea", "BA_Area", "BA_Length",
"RadiusofCircle", "MaximumDepth", "DepthCompactness",
"PerimeterArea", "PolsbyPopper", "ConvexHull", "Reock",
"BoundingBox", "Elongation", "RelativeSize_ancillary"
)
mydata <- data_raw[, cols_needed]
mydata <- na.omit(mydata)
## 获取所有组别
unique_clusters <- unique(mydata$CLUSTER_ID)
print(unique_clusters)
##########################################
## 2. 定义辅助函数，用于对某一组做 NMDS + 绘图
##########################################
plot_NMDS_kde_envfit <- function(subdata, group_label) {
# subdata: 当前分组数据
# group_label: 用于图表标题
## --- A. 数据预处理 ---
vars_for_nmds <- subdata[, !(names(subdata) %in% "CLUSTER_ID")]
vars_log <- log(vars_for_nmds + 1)  # log+1 处理0值
range01 <- function(x) {
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}
vars_scaled <- as.data.frame(lapply(vars_log, range01))
## --- B. NMDS ---
nmds_result <- metaMDS(vars_scaled,
distance = "euclidean",
k = 2,
trymax = 10)
cat("\n>>> Group:", group_label,
"NMDS stress =", nmds_result$stress, "\n")
## --- C. 核密度估计 ---
nmds_points <- as.data.frame(nmds_result$points)
colnames(nmds_points) <- c("NMDS1", "NMDS2")
kd2 <- kde2d(nmds_points$NMDS1, nmds_points$NMDS2, n = 200)
x_range <- range(kd2$x)
y_range <- range(kd2$y)
## --- D. 绘图：空白坐标系 + 背景渐变 + 等高线 ---
plot(NA, NA,
xlim = c(-1, 1.5),      # 或 x_range
ylim = c(-1.2, 1),        # 或 y_range
xlab = "NMDS1",
ylab = "NMDS2",
main = paste("Cluster", group_label),
asp = 1,
family = "Arial",       # 设置字体
cex.lab = 1.6,          # 坐标轴标题字体大小
cex.main = 1.6,         # 图标题字体大小
cex.axis = 1.3          # 坐标轴刻度字体大小
)
## 配置颜色渐变：从白到深蓝
my_cols <- colorRampPalette(
c("white", "#C8E4F9", "#83C7F3", "#379EE0", "#0059B3")
)(50)
## 填充核密度颜色
image(kd2, col = my_cols, add = TRUE)
## 等高线
contour(kd2,
nlevels    = 10,
drawlabels = FALSE,
lwd        = 1,
col        = "#333333",
add        = TRUE)
## 虚线辅助
abline(h = 0, v = 0, lty = 3, col = "gray40")
## --- E. envfit 分析 & 绘制 ---
ef <- envfit(nmds_result ~ ., data = vars_scaled, perm = 999)
cat("\nEnvfit results for group:", group_label, "\n")
print(ef)
## 使用 label.arg 传递 pos & offset，避免不是图形参数的警告
plot(ef,
p.max      = 0.05,          # 只画显著向量
col        = "black",       # 箭头颜色
lwd        = 1.5,           # 箭头线宽
cex        = 1.3,          # 字体大小
arrow.mul  = 1.1,           # 箭头缩放倍数
label.arg  = list(pos = 4,  # 文本相对位置(4=右侧)
offset = 0.4), # 文本与箭头间距
add        = TRUE)
}
##########################################
## 3. 循环对每个组别绘制
##########################################
for(g in unique_clusters) {
group_data <- subset(mydata, CLUSTER_ID == g)
plot_NMDS_kde_envfit(group_data, group_label = g)
}
